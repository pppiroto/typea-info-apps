<?xml version="1.0" encoding="UTF-8" ?> 
<Module>
  <ModulePrefs title="twitter search sample">
  	<Require feature="opensocial-0.8"/>
  </ModulePrefs> 
  <Content type="html">
     <![CDATA[ 
     	<script type="text/javascript">
	     	/**
	     	 * mixi アプリ :
	     	 * @see http://apiwiki.twitter.com/Twitter-Search-API-Method%3A-search
	     	 * @see http://code.google.com/intl/ja/apis/gadgets/docs/remote-content.html#Fetch_JSON
	     	 */
     		function search_twitter(url) {
     			var baseurl = "http://search.twitter.com/search.json";
     			if (url) {
     				url = baseurl + url;
     			} else {
     				url = baseurl + makeHttpParam('q', true);
				}
     			var params = {};
	    		params[gadgets.io.RequestParameters.METHOD] = gadgets.io.MethodType.GET;
	    		params[gadgets.io.RequestParameters.CONTENT_TYPE] = gadgets.io.ContentType.JSON;
     			gadgets.io.makeRequest(url, searchResponse, params);
     		}
     		function searchResponse(responseObj) {
     			var html = "";
     			var jsondata = responseObj.data
     			
     			var next_page = jsondata['next_page'];
     			if (next_page) {
     				html += "<a href='javascript:search_twitter(\"" + next_page + "\");'>next</a>";
     				html += "<br/>";
     			}
     			
     			var results = jsondata['results'];
     			for (var i=0; i<results.length; i++) {
     				var result = results[i];
     				html += "<a href='" + result['source'] + "'>";
     				html +=     "<img src='" + result['profile_image_url'] + "'/>";
     				html += "</a>";
     				html += toFuzzyUrlText(result['text']) + "</br>";
     			}
     			document.getElementById('content_div').innerHTML = html;
     		}
			function toFuzzyUrlText(text) {
				var ret = text;
				var ptn = /(http:\/\/.*)[^ ]/g;
				var ary = ptn.exec(text);
				while(ary) {
					ret.replace(ary[0], "< a href='" + ary[0] + "'>" + ary[0] + "</a>");
					ary = ptn.exec(text);
				}
				return ret;
			}
			
			/**
			 * HTTP GETリクエストパラメータを生成
			 */
     		function makeHttpParam(param_id, isFirstParam) {
     			isFirstParam = !(isFirstParam == undefined);
     			var paramObj = document.getElementById(param_id);
				var ret = "";
				if (paramObj != null) {
	     			ret = ((isFirstParam)?"?":"&") + param_id + "="
	     			     + encodeURIComponent(paramObj.value);
    			}
    			return ret;
     		}
       	</script>
       	<input type="text" size="16" id="q"/><input type="button" name="search" value="search" onclick="javascript:search_twitter();"/>
       	<div id="content_div"/>
     ]]>
  </Content> 
</Module>
